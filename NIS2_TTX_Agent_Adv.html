<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIS2 Table Top Exercise (TTX) - Logging Avanzato</title>
    
    <link rel="icon" href="data:," /> 

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #e9ecef; margin: 20px; }
        #ttx-app { max-width: 900px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 6px 15px rgba(0,0,0,0.1); }
        h1 { color: #004d99; border-bottom: 3px solid #004d99; padding-bottom: 10px; text-align: center; }
        h2 { color: #e95420; margin-top: 25px; }
        h3 { color: #333; margin-top: 15px; }
        #ttx-scenario { background-color: #f8f9fa; border: 1px solid #ced4da; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        #facilitator-instructions { background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 20px; border-radius: 8px; margin-top: 20px; }
        #log-entry { margin-top: 15px; padding: 15px; background-color: #e2e6ea; border-radius: 5px; }
        textarea { width: 100%; padding: 10px; box-sizing: border-box; border-radius: 5px; border: 1px solid #ccc; margin-top: 10px; }
        button { background-color: #28a745; color: white; border: none; padding: 12px 25px; margin-top: 20px; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; width: 100%; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .critical-action { font-weight: bold; color: #dc3545; }
    </style>
</head>
<body>

<div id="ttx-app">
    <h1>NIS2 Table Top Exercise (TTX)</h1>
    <p>Facilitatore: Segui le istruzioni dell'Agente. Le tue registrazioni saranno inviate automaticamente al Google Sheet.</p>

    <div id="ttx-scenario">
        </div>
    
    <div id="facilitator-instructions">
        <h2>üëâ Istruzioni per il Facilitatore (TUE Azioni)</h2>
        <p id="facilitator-text"></p>
        
        <div id="log-entry">
            <h3>üìù Registrazione Risposta</h3>
            <p><strong>Registra l'azione nel Log Condiviso.</strong> Inserisci qui sotto la risposta chiave e l'ora, poi clicca Continua.</p>
            <textarea id="facilitator-response-input" rows="3" placeholder="Digita qui la risposta completa del partecipante (es. 'L'IC ha risposto: Approvo l'isolamento dell'host X alle 10:05')."></textarea>
        </div>
        
        <button id="next-phase-button" onclick="handleLogInput()">Inizia TTX: FASE 1</button>
    </div>
    
    <div id="ttx-summary" style="display:none;">
        <h2>Esercizio Concluso</h2>
        <p>Il TTX √® terminato. Tutti i dati sono stati inviati al Google Sheet. Procedere con il Debriefing e la documentazione delle Lessons Learned.</p>
    </div>
</div>

<script>
    // VARIABILE CRITICA: URL DELLO SCRIPT APPS FORNITO DALL'UTENTE
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxOz8qku8IGfLABEjzeLo9Wg-4k2P-Z2wM3A-WlZqztwRbiwC1wnz7DFqw6RQofma-roA/exec'; 

    const ROLES = {
        IM_IC: "CIO (Incident Manager / Coordinator)",
        DPO: "DPO",
        SA_IRT: "System Administrator (Gruppo Operativo)",
        CSIRT_REF: "Gestore TTX (Referente CSIRT)",
        CEO_SEC: "Segretaria CEO (Comunicazione Direzione)"
    };

    const ttxPhases = [
        // --- FASE 1: Rilevamento e Triage (T + 30 minuti) ---
        {
            title: "FASE 1: Rilevamento e Triage (T = 10:00:00)",
            scenario: "Mercoled√¨ alle 10:00, il **System Administrator** riceve un avviso critico da un fornitore di servizi cloud: Credenziali amministrative compromesse e uso del dominio per una massiva campagna di phishing, causando interruzione del servizio. L'evento √® un Incidente Significativo.",
            actions: [
                {
                    role: ROLES.IM_IC,
                    question: "Quali sono le tue prime due azioni in qualit√† di Incident Coordinator per eseguire il Triage e la Dichiarazione dell'incidente Significativo? (Riferimento: Procedura 2.1)",
                    logInstruction: "Registra le prime due azioni dichiarate dal CIO (IC) e l'ora. Tempo massimo per la risposta: 5 minuti."
                },
                {
                    role: ROLES.CEO_SEC,
                    question: "L'IM (CIO) deve informare la Direzione Generale. Cosa deve comunicare l'IM e, soprattutto, quale canale di comunicazione (out of band) deve essere utilizzato? (Tempo Obiettivo: Entro 10:30:00)",
                    logInstruction: "Registra il canale e il contenuto della comunicazione alla Direzione (Segretaria CEO)."
                }
            ]
        },
        // --- FASE 2: Contenimento e Pre-Notifica (T + 24 ore) ---
        {
            title: "FASE 2: Contenimento e Notifica Critica (Scadenza: 10:00:00 del giorno dopo)",
            scenario: "Sono passate 2 ore da T. Il Contenimento deve essere eseguito rapidamente. Il CIO (IM) deve approvare le azioni.",
            actions: [
                {
                    role: ROLES.SA_IRT,
                    question: "Quali sono le misure immediate di Contenimento che proponi per l'ambiente di posta (Exchange) e per la rete per limitare la diffusione del danno e preservare le prove?",
                    logInstruction: "Registra le azioni di Contenimento proposte dal System Admin (IRT) e l'approvazione/rifiuto del CIO (IM)."
                },
                {
                    role: ROLES.CSIRT_REF,
                    question: "<span class='critical-action'>AZIONE CRITICA NIS2:</span> Cosa deve essere preparato e inviato Entro 24 ore da T? Quali tre informazioni (almeno) deve includere questa comunicazione (Early Warning)?",
                    logInstruction: "Registra le tre informazioni chiave che il Gestore TTX (Referente CSIRT) invier√† al CSIRT Italia per l'Early Warning."
                }
            ]
        },
        // --- FASE 3: Data Breach Check & Notifica Completa (T + 72 ore) ---
        {
            title: "FASE 3: Data Breach Check & Notifica Completa (Scadenza: 10:00:00 - 3 giorni dopo)",
            scenario: "Durante l'analisi, il System Administrator scopre che le credenziali compromesse davano accesso anche a un database con PII (nomi e indirizzi email) di 500 clienti.",
            actions: [
                {
                    role: ROLES.DPO,
                    question: "Valutazione: Si tratta di un Data Breach con rischio? Qual √® la tua azione obbligatoria, e verso quale autorit√†? (Riferimento: GDPR)",
                    logInstruction: "Registra l'analisi del DPO sull'obbligo di notifica e l'autorit√† destinataria (Garante Privacy)."
                },
                {
                    role: ROLES.CSIRT_REF,
                    question: "La scadenza di 72 ore si avvicina. Qual √® lo scopo della **Incident Notification (Completa)** e quali sono i due nuovi dettagli che devi fornire rispetto alla Pre-Notifica?",
                    logInstruction: "Registra lo scopo e i due nuovi dettagli (Valutazione dettagliata e Causa Probabile) per la Notifica Completa."
                }
            ]
        },
        // --- FASE 4: Chiusura e Lessons Learned (T + 1 Mese) ---
        {
            title: "FASE 4: Eradication, Recovery e Chiusura",
            scenario: "L'Eradication (rimozione delle backdoor, cambio password) e il Recovery sono stati eseguiti. L'IC chiude l'incidente.",
            actions: [
                {
                    role: ROLES.IM_IC,
                    question: "In qualit√† di Incident Manager, quali due passaggi sono fondamentali per la fase Post-Incident prima della chiusura definitiva, e qual √® il loro scopo? (Riferimento: Procedura 3.1)",
                    logInstruction: "Registra i due passaggi: PIR (Post-Incident Review) e Lessons Learned."
                },
                {
                    role: ROLES.CSIRT_REF,
                    question: "Qual √® la scadenza finale per la notifica, e quale documento deve essere sottomesso al CSIRT per concludere formalmente l'incidente?",
                    logInstruction: "Registra la scadenza (1 Mese) e il documento finale (Relazione Finale) sottomesso al CSIRT."
                }
            ]
        }
    ];

    let currentPhaseIndex = 0;
    let currentActionIndex = 0;
    let currentLogData = {}; 

    window.onload = function() {
        // Il pulsante deve essere abilitato all'avvio
        document.getElementById('next-phase-button').disabled = false; 
        document.getElementById('next-phase-button').textContent = "Inizia TTX: FASE 1";
        renderPhase();
    };

    function renderPhase() {
        const phase = ttxPhases[currentPhaseIndex];
        const action = phase.actions[currentActionIndex];

        const scenarioDiv = document.getElementById('ttx-scenario');
        const facilitatorText = document.getElementById('facilitator-text');
        const nextButton = document.getElementById('next-phase-button');

        // 1. Aggiorna lo Scenario e la Fase
        scenarioDiv.innerHTML = `
            <h2>${phase.title}</h2>
            <p><strong>Scenario:</strong> ${phase.scenario}</p>
            <p class="critical-action">ATTENZIONE! L'orologio √® attivo per le scadenze NIS2.</p>
        `;

        // 2. Istruzioni per il Facilitatore
        facilitatorText.innerHTML = `
            <p><strong>Domanda a:</strong> <span style="color:#004d99; font-weight:bold;">${action.role}</span></p>
            <p><strong>Domanda:</strong> ${action.question}</p>
        `;

        // 3. Istruzioni per il Log (per guidare la registrazione)
        document.getElementById('log-entry').innerHTML = `
            <h3>üìù Registrazione Risposta</h3>
            <p><strong>AZIONE RICHIESTA:</strong> Chiedi la risposta a <strong>${action.role}</strong>.</p>
            <p><strong>DA REGISTRARE:</strong> ${action.logInstruction}</p>
            <textarea id="facilitator-response-input" rows="3" placeholder="Digita qui la risposta completa del partecipante e l'ora."></textarea>
        `;

        // 4. Prepara i dati di logging per l'azione corrente
        currentLogData = {
            phase_id: ttxPhases[currentPhaseIndex].title,
            role: action.role,
            question: action.question,
        };

        // 5. Reset Button
        nextButton.textContent = `Registra e Continua (${currentActionIndex + 1}/${phase.actions.length} Azioni in FASE ${currentPhaseIndex + 1})`;
        nextButton.disabled = false; 
    }

    // Funzione Aggiunta: Gestisce l'input del facilitatore e abilita l'invio
    function handleLogInput() {
        const responseInput = document.getElementById('facilitator-response-input').value;
        
        if (responseInput.trim() === '') {
            alert("Per favore, inserisci la risposta registrata prima di procedere, altrimenti il log sar√† vuoto.");
            return;
        }
        
        // 1. Aggiorna i dati con la risposta del facilitatore
        currentLogData.response_recorded = responseInput;
        
        // 2. Invia il dato al Google Sheet in background
        sendToGoogleSheet(currentLogData);

        // 3. Procedi alla fase successiva o alla prossima azione
        processNextAction();
    }

    // Funzione Aggiunta: Invia i dati al Google Sheet tramite la funzione Serverless
    function sendToGoogleSheet(data) {
        
        const formData = new FormData();
        formData.append('Timestamp', new Date().toISOString());
        formData.append('Fase_ID', data.phase_id);
        formData.append('Ruolo_Coinvolto', data.role);
        formData.append('Domanda', data.question.replace(/<[^>]*>?/gm, '')); // Rimuove HTML
        formData.append('Risposta_Registrata', data.response_recorded);
        
        // Uso di fetch con mode: 'no-cors' per la comunicazione con Apps Script
        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            body: formData,
            mode: 'no-cors'
        })
        .then(response => {
            console.log('Dati inviati con successo al Google Sheet (risposta fetch ignorata in no-cors).');
        })
        .catch(error => {
            console.error('Errore durante l\'invio dei dati (controlla la configurazione di Apps Script):', error);
            alert("ATTENZIONE: Errore nell'invio dei dati al foglio di calcolo. Controlla la console per i dettagli.");
        });
    }

function processNextAction() {
    
    const totalActionsInCurrentPhase = ttxPhases[currentPhaseIndex].actions.length;
    const totalPhases = ttxPhases.length;

    // A. Check if the current action is the LAST action of the LAST phase
    if (currentPhaseIndex === totalPhases - 1 && currentActionIndex === totalActionsInCurrentPhase - 1) {
        // Ultima azione dell'ultima fase completata.
        endTTX();
        return; // Termina qui l'esecuzione
    }

    // B. Avanza all'azione successiva (nella stessa fase)
    currentActionIndex++;
    
    // C. Controlla se le azioni nella fase corrente sono finite (se B non √® soddisfatto)
    if (currentActionIndex >= totalActionsInCurrentPhase) {
        // Se le azioni sono finite, passa alla fase successiva
        currentPhaseIndex++;
        currentActionIndex = 0; // Resetta l'indice dell'azione
        
        // Aggiorna il testo del pulsante
        if (currentPhaseIndex < totalPhases) {
            document.getElementById('next-phase-button').textContent = `Passa alla FASE ${currentPhaseIndex + 1}`;
        }
    }
    
    // D. Rendi la fase o azione successiva
    renderPhase();
}
    
function endTTX() {
    const ttxSummaryDiv = document.getElementById('ttx-summary');
    const ttxAppDiv = document.getElementById('ttx-app');

    // Assicurati che il contenitore principale sparisca
    ttxAppDiv.style.display = 'none';

    // Mostra il riepilogo finale
    ttxSummaryDiv.style.display = 'block';
    ttxSummaryDiv.innerHTML = `
        <h2>‚úÖ Test Completato!</h2>
        <p><strong>Riepilogo:</strong> L'Esercizio TTX √® terminato.</p>
        <p>Tutte le azioni sono state registrate e inviate al Google Sheet tramite lo script serverless.</p>
        <p>Procedi ora con il Debriefing (Post-Incident Review) e la documentazione delle Lessons Learned con il team.</p>
    `;
    
    // Mostra anche la console per feedback visivo, se l'utente la sta guardando
    console.log("TTX completato. Fine dell'esercizio."); 
}
</script>

</body>
</html>
